# =============================================================================
# Entanglement Server - Docker Compose
# =============================================================================
#
# QUICK START:
#   1. cp .env.example .env
#   2. echo "JWT_SECRET=$(openssl rand -hex 32)" >> .env
#   3. docker compose up -d
#
# COMMANDS:
#   Logs:     docker compose logs -f server
#   Stop:     docker compose down
#   Rebuild:  docker compose up -d --build
#   Reset:    docker compose down -v  (WARNING: deletes all data!)
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Entanglement Server
  # ---------------------------------------------------------------------------
  server:
    build: .
    container_name: entanglement-server
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      JWT_SECRET: ${JWT_SECRET:-}
      DATABASE_URL: postgres://entanglement:${POSTGRES_PASSWORD:-entanglement}@postgres:5432/entanglement
      BLOB_STORAGE_PATH: /data/blobs
      SERVER_NAME: ${SERVER_NAME:-Entanglement}
      REST_PORT: ${REST_PORT:-1975}
      GRPC_PORT: ${GRPC_PORT:-50051}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://127.0.0.1:3000,http://instability-index:3000}
      ACCESS_TOKEN_HOURS: ${ACCESS_TOKEN_HOURS:-24}
      REFRESH_TOKEN_DAYS: ${REFRESH_TOKEN_DAYS:-30}
      AUTH_RATE_LIMIT: ${AUTH_RATE_LIMIT:-5}
      AUTH_RATE_BURST: ${AUTH_RATE_BURST:-10}
      MAX_UPLOAD_SIZE: ${MAX_UPLOAD_SIZE:-1073741824}
    ports:
      - "${REST_PORT:-1975}:${REST_PORT:-1975}"
      - "${GRPC_PORT:-50051}:${GRPC_PORT:-50051}"
      - "${WEB_PORT:-3000}:${WEB_PORT:-3000}"
    volumes:
      - ${DATA_PATH:-./data}/blobs:/data/blobs
    networks:
      - entanglement-internal
    restart: unless-stopped
    entrypoint: ["/entrypoint.sh"]
    command: ["tangled", "serve", "--foreground"]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${REST_PORT:-1975}/server/info"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: entanglement-postgres
    environment:
      POSTGRES_USER: entanglement
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-entanglement}
      POSTGRES_DB: entanglement
    volumes:
      - ${DATA_PATH:-./data}/postgres:/var/lib/postgresql/data
    networks:
      - entanglement-internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U entanglement -d entanglement"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

networks:
  entanglement-internal:
    driver: bridge
