services:
  postgres:
    image: docker.io/library/postgres:16-alpine
    container_name: entanglement-db
    environment:
      POSTGRES_USER: entanglement
      # SECURITY: Change this password in production!
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-entanglement}
      POSTGRES_DB: entanglement
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      # Local data path - data persists in ./data/postgres
      - ${DATA_PATH:-./data}/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U entanglement"]
      interval: 5s
      timeout: 5s
      retries: 5

  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: entanglement-server
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # ===========================================
      # SECURITY SETTINGS
      # ===========================================
      
      # REQUIRED for production: Set a persistent JWT secret
      # Generate with: openssl rand -hex 32
      # If not set, a random secret is generated on each restart (logs out all users)
      JWT_SECRET: ${JWT_SECRET:-}
      
      # Database connection (uses same password as postgres service)
      DATABASE_URL: postgres://entanglement:${POSTGRES_PASSWORD:-entanglement}@postgres:5432/entanglement
      
      # ===========================================
      # SERVER SETTINGS
      # ===========================================
      
      # Storage path for file blobs (inside container)
      BLOB_STORAGE_PATH: /data/blobs
      
      # API ports
      REST_PORT: ${REST_PORT:-8080}
      GRPC_PORT: ${GRPC_PORT:-50051}
      
      # CORS allowed origins (comma-separated)
      # Default allows localhost for development
      # For production, set to your actual domain(s)
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://127.0.0.1:3000}
      
      # ===========================================
      # RATE LIMITING (Security)
      # ===========================================
      
      # Auth endpoint rate limit (requests per second)
      AUTH_RATE_LIMIT: ${AUTH_RATE_LIMIT:-5}
      AUTH_RATE_BURST: ${AUTH_RATE_BURST:-10}
      
      # ===========================================
      # TOKEN SETTINGS (Security)
      # ===========================================
      
      # Access token expiration in hours (default: 24)
      ACCESS_TOKEN_HOURS: ${ACCESS_TOKEN_HOURS:-24}
      
      # Refresh token expiration in days (default: 30)
      REFRESH_TOKEN_DAYS: ${REFRESH_TOKEN_DAYS:-30}
      
      # ===========================================
      # UPLOAD LIMITS (Security)
      # ===========================================
      
      # Maximum upload size in bytes (default: 1GB)
      MAX_UPLOAD_SIZE: ${MAX_UPLOAD_SIZE:-1073741824}
      
    ports:
      - "${REST_PORT:-8080}:8080"
      - "${GRPC_PORT:-50051}:50051"
      - "${WEB_PORT:-3000}:3000"
    volumes:
      # Local data path - blobs persist in ./data/blobs
      - ${DATA_PATH:-./data}/blobs:/data/blobs
    entrypoint: ["/entrypoint.sh"]
    command: ["tangled", "serve", "--foreground"]
    restart: unless-stopped
